name: CI

on:
  pull_request:
    branches: [ "master", "develop" ]
    paths-ignore: [ "docs/**" ]

  push:
    branches: [ "master", "develop" ]
    paths-ignore: [ "docs/**" ]

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 1
      fail-fast: true
      matrix:
        node-version: [14.x]

    steps:
      - uses: actions/checkout@v1

      - name: Node ${{ matrix.node }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}

      - name: Install dependencies
        run: npm install

      - name: Lint
        run: npm run lint

  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.x]

    steps:
      - uses: actions/checkout@v1

      - name: Node ${{ matrix.node }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}

      - name: Install dependencies
        run: npm install

      - name: Unit Tests
        uses: GabrielBB/xvfb-action@v1
        with:
          run: npm run test

      - name: Upload coverage
        uses: codecov/codecov-action@v1
        with:
          fail_ci_if_error: true

  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.x]

    steps:
      - uses: actions/checkout@v1

      - name: Node ${{ matrix.node }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build

      - name: Package application
        uses: vimtor/action-zip@v1
        with:
          files: ./dist/static
          recursive: false
          dest: site.zip

      - name: Deploy
        uses: wei/curl@v1.1.1
        with:
          args: '-v -X POST -H "Accept: application/json" -H "Authorization: Bearer 36|u83c2SBokYc8w1Pu1wCDDdmDiRgRNLmg9bIZKXJm" -F "file=@./site.zip" https://hostme.space/api/websites/valerymelou/deploy_on_push'
        env:
          host_me_key: ${{ secrets.HOST_ME_KEY }}

      - name: Artifact
        uses: actions/upload-artifact@v1
        with:
          name: current-deployed
          path: ${{ github.workspace }}/site.zip

